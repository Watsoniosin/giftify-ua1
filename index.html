<script type="module">
  // === ЗАХИСТ ВІД БІЛОГО ЕКРАНУ ===
  function initTelegramWebApp() {
    if (window.Telegram?.WebApp) {
      window.Telegram.WebApp.ready();
      window.Telegram.WebApp.expand();
      return window.Telegram.WebApp;
    } else {
      console.warn('Telegram WebApp not found — using mock');
      window.Telegram = {
        WebApp: {
          initData: 'mock',
          initDataUnsafe: { user: { id: 999, first_name: 'Гість', username: 'guest' } },
          ready: () => console.log('Mock ready'),
          expand: () => console.log('Mock expand'),
          MainButton: {
            setText: (t) => { this._text = t; return this; },
            onClick: (cb) => { this._click = cb; return this; },
            show: () => console.log('MainButton shown'),
            _text: '',
            _click: null
          }
        }
      };
      return window.Telegram.WebApp;
    }
  }

  // Чекаємо DOM
  document.addEventListener('DOMContentLoaded', async () => {
    const tg = initTelegramWebApp();
    const tgUser = tg.initDataUnsafe?.user || { id: 999, first_name: 'Гість', username: 'guest' };

    // === ІМПОРТИ ===
    const { User } = await import('./src/domain/User.js');
    const { GetBalanceUseCase } = await import('./src/application/GetBalanceUseCase.js');
    const { MockBalanceGateway } = await import('./src/infrastructure/gateways/MockBalanceGateway.js');
    const { HttpGiftGateway } = await import('./src/infrastructure/gateways/HttpGiftGateway.js');

    // === USER ===
    const user = new User(tgUser.id, tgUser.first_name, tgUser.username);
    document.getElementById('username').textContent = user.getDisplayName();

    // === БАЛАНС ===
    const balanceGateway = new MockBalanceGateway('777.77');
    const useCase = new GetBalanceUseCase(balanceGateway);

    async function updateBalance() {
      try {
        const balance = await useCase.execute(user.id);
        document.getElementById('balance').textContent = `${balance.toFixed(2)} $`;
      } catch (e) {
        console.error(e);
      }
    }

    document.getElementById('refresh-btn').onclick = updateBalance;
    tg.MainButton.setText('Оновити').onClick(updateBalance).show();
    updateBalance();

    // === АНІМАЦІЯ ===
    const giftGateway = new HttpGiftGateway();
    const GIFT_ID = 'AstralShard-21';

    async function loadGift() {
      try {
        const animData = await giftGateway.loadGiftAnimation(GIFT_ID);
        lottie.loadAnimation({
          container: document.getElementById('gift-anim'),
          renderer: 'svg',
          loop: true,
          autoplay: true,
          animationData: animData
        });
      } catch (error) {
        console.error('Gift error:', error);
        const container = document.getElementById('gift-anim');
        if (container) container.innerHTML = '<p style="color:red">Анімація недоступна</p>';
      }
    }

    loadGift();
  });
</script>
